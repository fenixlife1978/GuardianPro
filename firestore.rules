rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy:
     * This ruleset enforces a strict multi-tenant security model. Data is partitioned by
     * an 'institution', and a user's access is determined by their assigned
     * 'institutionId' and role (e.g., Super Admin), which are expected to be present
     * as custom claims in their authentication token. This prevents users from one
     * institution from accessing the data of another.
     *
     * Key Security Decisions:
     * - Super Admin Override: The Super Admin role grants full read/write access across all 
     *   institutions. This is checked first in subcollection rules.
     * - Tenant Isolation: A regular user can only access data within the institution
     *   specified in their auth token. Listing all institutions is denied to regular users.
     * - Denormalization for Security: The `institutionId` is denormalized on documents
     *   within subcollections (e.g., classrooms, devices) to allow rules to validate
     *   tenant ownership without performing costly `get()` calls.
     */

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      // Super admin is defined by a specific UID or a custom claim.
      return isSignedIn() && (request.auth.uid == 'QeGMDNE4GaSJOU8XEnY3lFJ9by13' || request.auth.token.isSuperAdmin == true);
    }

    function isMemberOfInstitution(institutionId) {
      // Regular admins must have an institutionId in their custom claims.
      return isSignedIn() && request.auth.token.institutionId == institutionId;
    }

    function hasCorrectInstitutionIdOnCreate(institutionId) {
        return request.resource.data.institutionId == institutionId;
    }

    function institutionIdIsImmutable() {
        return request.resource.data.institutionId == resource.data.institutionId;
    }

    function hasCorrectClassroomIdOnCreate(classroomId) {
      return request.resource.data.classroomId == classroomId;
    }

    function classroomIdIsImmutable() {
      return request.resource.data.classroomId == resource.data.classroomId;
    }

    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    match /users/{userId} {
      allow get, update: if isSuperAdmin() || request.auth.uid == userId;
      allow create, delete, list: if isSuperAdmin();
    }

    match /institutions/{institutionId} {
      // This rule grants access to the institution document itself.
      allow get: if isSuperAdmin() || isMemberOfInstitution(institutionId);
      allow list, create, update, delete: if isSuperAdmin();

      // Rules for subcollections must re-evaluate permissions.
      // A rule on a parent document does NOT automatically grant access to subcollections.

      match /Aulas/{classroomId} {
        // Super Admins get full access. Regular members are restricted.
        allow get, list, delete: if isSuperAdmin() || isMemberOfInstitution(institutionId);
        allow create: if isSuperAdmin() || (isMemberOfInstitution(institutionId) && hasCorrectInstitutionIdOnCreate(institutionId));
        allow update: if isSuperAdmin() || (isMemberOfInstitution(institutionId) && institutionIdIsImmutable());

        match /Alumnos/{deviceId} {
            // Super Admins get full access. Regular members are restricted.
            allow get, list, delete: if isSuperAdmin() || isMemberOfInstitution(institutionId);
            allow create: if isSuperAdmin() || (isMemberOfInstitution(institutionId) 
                            && hasCorrectInstitutionIdOnCreate(institutionId)
                            && hasCorrectClassroomIdOnCreate(classroomId));
            allow update: if isSuperAdmin() || (isMemberOfInstitution(institutionId) 
                            && institutionIdIsImmutable()
                            && classroomIdIsImmutable());
        }
      }
    }
    
    // Temp collection for enrollment flow.
    match /pending_enrollments/{enrollmentId} {
        allow read, write: if isSignedIn();
    }
  }
}
