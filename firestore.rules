rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy:
     * This ruleset enforces a strict multi-tenant security model. Data is partitioned by
     * an 'institution', and a user's access is determined by their assigned
     * 'institutionId' and role (e.g., Super Admin), which are expected to be present
     * as custom claims in their authentication token. This prevents users from one
     * institution from accessing the data of another.
     *
     * Data Structure:
     * The data is organized hierarchically, with top-level 'institutions' collections.
     * All other data, such as classrooms and devices, are stored in subcollections
     * under their respective institution. This structure enables clear, path-based
     * security rules and efficient, tenant-scoped queries.
     *
     * Key Security Decisions:
     * - Authorization via UID and Custom Claims: Access is primarily controlled by a specific Super Admin UID
     *   or custom claims (institutionId, isSuperAdmin) in the user's auth token.
     * - Super Admin Role: A global Super Admin role is implemented, granting full
     *   read/write access across all institutions for management purposes.
     * - Tenant Isolation: The core rule is that a regular user can only access data
     *   within the institution specified in their auth token. Listing all institutions is
     *   denied to regular users to prevent information leakage.
     *
     * Denormalization for Authorization:
     * To ensure fast and secure authorization, the `institutionId` is denormalized
     * and stored on documents within subcollections (e.g., classrooms, devices).
     * This allows rules to validate tenant ownership without performing costly `get()` calls.
     */

    //-------------------------------------------------------------------------
    // Helper Functions
    //-------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return isSignedIn() && (request.auth.uid == 'QeGMDNE4GaSJOU8XEnY3lFJ9by13' || request.auth.token.isSuperAdmin == true);
    }

    function isMemberOfInstitution(institutionId) {
      return isSignedIn() && request.auth.token.institutionId == institutionId;
    }

    function isInstitutionMemberOrSuperAdmin(institutionId) {
      return isSuperAdmin() || isMemberOfInstitution(institutionId);
    }

    function hasCorrectInstitutionIdOnCreate(institutionId) {
        return request.resource.data.institutionId == institutionId;
    }

    function institutionIdIsImmutable() {
        return request.resource.data.institutionId == resource.data.institutionId;
    }

    function hasCorrectClassroomIdOnCreate(classroomId) {
      return request.resource.data.classroomId == classroomId;
    }

    function classroomIdIsImmutable() {
      return request.resource.data.classroomId == resource.data.classroomId;
    }

    //-------------------------------------------------------------------------
    // Collection Rules
    //-------------------------------------------------------------------------

    match /users/{userId} {
      allow get, update: if isSuperAdmin() || request.auth.uid == userId;
      allow create, delete: if isSuperAdmin();
      allow list: if isSuperAdmin();
    }

    match /institutions/{institutionId} {
      allow get: if isInstitutionMemberOrSuperAdmin(institutionId);
      allow list, create, update, delete: if isSuperAdmin();

      match /Aulas/{classroomId} {
        allow get, list: if isInstitutionMemberOrSuperAdmin(institutionId);
        allow create: if isInstitutionMemberOrSuperAdmin(institutionId) && hasCorrectInstitutionIdOnCreate(institutionId);
        allow update: if isInstitutionMemberOrSuperAdmin(institutionId) && institutionIdIsImmutable();
        allow delete: if isInstitutionMemberOrSuperAdmin(institutionId);

        match /Alumnos/{deviceId} {
            allow get, list: if isInstitutionMemberOrSuperAdmin(institutionId);
            allow create: if isInstitutionMemberOrSuperAdmin(institutionId) 
                            && hasCorrectInstitutionIdOnCreate(institutionId)
                            && hasCorrectClassroomIdOnCreate(classroomId);
            allow update: if isInstitutionMemberOrSuperAdmin(institutionId) 
                            && institutionIdIsImmutable()
                            && classroomIdIsImmutable();
            allow delete: if isInstitutionMemberOrSuperAdmin(institutionId);
        }
      }
    }
    
    // Temp collection for enrollment flow.
    // Allow any authenticated user to create a pending enrollment.
    // The device itself might be anonymous at this point.
    // The `confirmEnrollment` function (run by an admin) will securely move the data.
    match /pending_enrollments/{enrollmentId} {
        allow read, write: if isSignedIn();
    }
  }
}
